# 混合模式实施计划

> **创建日期**: 2026-02-04
> **预计工期**: 11-16 天
> **当前分支**: feature/hybrid-mode-implementation
> **相关设计文档**: docs/design/hybrid-mode-design.md

---

## 📋 任务概述

基于混合模式架构设计，实施对 Claude CLI Provider 的完整重构，同时支持：
1. **OpenAI 兼容模式** - 标准化 API，适合简单场景（现有功能增强）
2. **Agent 模式** - 完整功能，支持工具调用和多轮对话（新增）

---

## 🎯 阶段划分

### 阶段 1: 基础重构（2-3 天）[进行中]

**目标**: 重构现有代码，建立模块化架构

**详细任务**:
1. 创建 `lib/` 目录结构
   - `lib/adapters/` - 适配器层
   - `lib/formatters/` - 格式化工具
   - `lib/claude/` - Claude 进程管理
   - `lib/utils/` - 通用工具

2. 实现共享组件
   - `lib/formatters/message-formatter.js` - 消息格式化
   - `lib/formatters/response-transformer.js` - 响应转换
   - `lib/utils/logger.js` - 日志工具
   - `lib/utils/errors.js` - 错误定义

3. 重构现有代码
   - 将 `server.js` 中的现有逻辑提取到 `lib/adapters/cli-adapter.js`
   - 保持向后兼容，确保现有功能正常工作

4. 单元测试
   - 为所有新组件添加单元测试
   - 测试覆盖率达到 80% 以上

**完成标准**:
- [x] 目录结构创建完成
- [x] 共享组件实现完成
- [x] 现有功能重构到 `cli-adapter.js`
- [x] 所有测试通过
- [x] 现有 API 功能不受影响

**执行结果**: _待填写_

**状态**: 进行中

---

### 阶段 2: OpenAI 模式增强（1-2 天）[待开始]

**目标**: 增强 OpenAI 兼容接口，支持更多参数

**详细任务**:
1. 支持系统提示词
   - 从 `messages` 中提取 `role: 'system'` 的消息
   - 使用 `--system-prompt` 参数传递给 Claude CLI

2. 支持多轮对话上下文
   - 构建完整的对话历史
   - 过滤 `user` 和 `assistant` 消息
   - 按正确顺序传递给 Claude CLI

3. 支持更多 OpenAI 参数
   - `max_tokens` - 后处理截断
   - `stop` - 停止序列检测
   - 记录不支持的参数（`temperature`, `top_p` 等）并发出警告

4. 更新文档
   - API 文档更新
   - 添加使用示例

**完成标准**:
- [ ] 系统提示词生效
- [ ] 多轮对话正常工作
- [ ] 参数警告日志正常
- [ ] 文档更新完成

**执行结果**: _待填写_

**状态**: 待开始

---

### 阶段 3: PTY 适配器实现（3-4 天）[待开始]

**目标**: 实现 PTY 适配器，支持完整的 Claude CLI 功能

**详细任务**:
1. 安装和配置 node-pty
   - 添加 `node-pty` 和 `uuid` 依赖
   - 验证在各平台上的安装
   - 添加安装说明到文档

2. 实现 `lib/adapters/pty-adapter.js`
   - 使用 node-pty 创建伪终端
   - 启动 Claude CLI（交互模式）
   - 实现屏幕快照功能
   - 实现屏幕稳定性检测

3. 实现消息提取
   - 从终端屏幕提取新内容
   - 使用 diff 算法比较屏幕变化
   - 过滤 TUI 元素（输入框、状态栏等）

4. 实现工具调用检测
   - 检测 Claude CLI 的工具调用模式
   - 解析工具名称和参数
   - 记录工具调用结果

5. 单元测试
   - PTY 适配器测试
   - 消息提取测试
   - 工具调用检测测试

**完成标准**:
- [ ] PTY 进程正常启动
- [ ] 屏幕内容正确捕获
- [ ] 消息提取准确
- [ ] 工具调用检测正常
- [ ] 所有测试通过

**执行结果**: _待填写_

**状态**: 待开始

---

### 阶段 4: Agent 接口实现（2-3 天）[待开始]

**目标**: 实现 Agent 模式的 API 接口

**详细任务**:
1. 实现 SessionManager
   - 创建 `lib/claude/session-manager.js`
   - 实现会话创建、获取、删除
   - 实现消息历史管理
   - 实现会话过期清理

2. 实现 `/v1/agent/chat` 路由
   - 创建 `routes/agent.js`
   - 实现 POST 请求处理
   - 实现 SSE 事件流
   - 集成 PTY 适配器

3. 实现会话管理路由
   - GET `/v1/agent/sessions` - 列出所有会话
   - GET `/v1/agent/sessions/:id` - 获取会话详情
   - DELETE `/v1/agent/sessions/:id` - 删除会话
   - POST `/v1/agent/sessions/:id/attach` - 附加到会话

4. 集成测试
   - Agent 接口测试
   - 会话管理测试
   - 工具调用测试

**完成标准**:
- [ ] Agent 接口可用
- [ ] 会话管理正常
- [ ] 工具调用工作
- [ ] SSE 事件流正常
- [ ] 所有测试通过

**执行结果**: _待填写_

**状态**: 待开始

---

### 阶段 5: 测试和优化（2-3 天）[待开始]

**目标**: 全面测试和性能优化

**详细任务**:
1. 端到端测试
   - OpenAI 模式完整流程测试
   - Agent 模式完整流程测试
   - 边界情况测试
   - 错误处理测试

2. 性能测试
   - 并发请求测试
   - 内存占用测试
   - 响应时间测试
   - 进程泄漏检测

3. 错误处理完善
   - 添加详细的错误日志
   - 实现优雅的错误恢复
   - 添加用户友好的错误提示

4. 日志和监控
   - 添加性能指标收集
   - 实现请求追踪
   - 添加健康检查增强

5. 文档完善
   - API 文档更新
   - 部署文档更新
   - 添加故障排查指南

**完成标准**:
- [ ] 所有测试通过
- [ ] 性能满足要求
- [ ] 无已知严重 Bug
- [ ] 文档完整

**执行结果**: _待填写_

**状态**: 待开始

---

### 阶段 6: 部署和发布（1 天）[待开始]

**目标**: 部署到生产环境并发布新版本

**详细任务**:
1. 更新部署文档
   - 添加 node-pty 安装说明
   - 更新环境变量配置
   - 添加性能调优建议

2. 版本发布
   - 更新版本号到 v2.0.0
   - 更新 CHANGELOG.md
   - 创建 Git 标签
   - 创建 GitHub Release

3. 部署
   - 更新 PM2 配置
   - 更新 Docker 配置
   - 部署到生产环境
   - 验证部署成功

**完成标准**:
- [ ] 部署文档更新完成
- [ ] 版本发布完成
- [ ] 生产环境部署成功
- [ ] 功能验证通过

**执行结果**: _待填写_

**状态**: 待开始

---

## 📊 整体进展

- **已完成**: 0 / 6
- **当前阶段**: 阶段 1 - 基础重构
- **预计完成日期**: 2026-02-20

---

## 🔗 依赖关系

```
阶段 1 (基础重构)
    │
    ├─→ 阶段 2 (OpenAI 增强) - 可独立进行
    │
    └─→ 阶段 3 (PTY 适配器)
           │
           └─→ 阶段 4 (Agent 接口)
                  │
                  └─→ 阶段 5 (测试优化)
                         │
                         └─→ 阶段 6 (部署发布)
```

---

## 📝 重要备注

### 技术决策记录

1. **node-pty 选择**
   - 原因: 成熟稳定，维护活跃
   - 风险: 需要原生编译，安装可能复杂
   - 备选方案: `pty.js`

2. **会话存储方式**
   - 使用内存存储（Map）
   - 后续可扩展为 Redis
   - 需要注意进程重启丢失会话

3. **进程管理**
   - CLI 模式: 每次请求创建新进程（无状态）
   - Agent 模式: 复用 PTY 进程（有状态）
   - 需要实现进程池限制

### 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| node-pty 安装失败 | 高 | 提前验证，准备替代方案 |
| PTY 解析脆弱 | 中 | 参考 AgentAPI，充分测试 |
| 性能问题 | 中 | 进程池，资源限制 |
| 会话泄漏 | 中 | 定期清理，监控 |

### 需要外部协作

- 需要 Claude CLI 团队提供 CLI 输出格式文档
- 需要测试团队准备测试用例
- 需要运维团队准备生产环境

---

## 📚 参考文档

- [混合模式架构设计](./docs/design/hybrid-mode-design.md)
- [OpenAI 兼容性分析](./docs/design/openai-compatibility-analysis.md)
- [AgentAPI 实现分析](./docs/design/agentapi-implementation-analysis.md)

---

**最后更新**: 2026-02-04
**更新人**: Claude Code
**状态**: 进行中
